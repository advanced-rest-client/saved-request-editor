<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../polymer/lib/legacy/class.html">
<link rel="import" href="../polymer/lib/utils/render-status.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-chip-input/paper-chip-input.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../arc-icons/arc-icons.html">

<dom-module id="saved-request-editor">
  <template>
    <style>
    :host {
      display: block;
      outline: none;
      @apply --arc-font-body1;
      @apply --saved-request-editor;
    }

    form {
      outline: none;
    }

    .additional-options {
      color: rgba(0, 0, 0, 0.74);
    }

    .caption {
      @apply --layout-horizontal;
      @apply --layout-center;
      cursor: pointer;
    }

    .options {
      margin-top: 16px;
    }

    .actions {
      @apply --layout-horizontal;
      @apply --layout-end-justified;
      margin-top: 20px;
      @apply --saved-request-editor-actions-container;
    }

    .actions paper-button {
      color: var(--primary-color);
      padding-left: 12px;
      padding-right: 12px;
      @apply --saved-request-editor-action-buttons;
    }

    .actions paper-button.action-button {
      @apply --action-button;
    }
    </style>
    <iron-form id="form" on-iron-form-presubmit="_formSubmit">
      <form method="post">
        <paper-input label="Request name (required)" required auto-validate error-message="Name is required" value="{{name}}"></paper-input>
        <paper-textarea id="autogrow" label="Description (optional)" value="{{description}}" on-bind-value-changed="_autogrowCheckResize"></paper-textarea>
        <paper-chip-input label="Add to project" value="{{selectedProjects}}" source="[[_computeAutocomplete(projects)]]" chip-remove-icon="arc:close"></paper-chip-input>
        <section class="additional-options">
          <div class="caption" on-click="_toggleOptions">
            Additional options
            <paper-icon-button icon="arc:arrow-drop-down"></paper-icon-button>
          </div>
          <iron-collapse opened="[[additionalOptionsOpened]]">
            <div class="options">
              <paper-checkbox checked="{{isDrive}}">Save to Google Drive</paper-checkbox>
            </div>
          </iron-collapse>
        </section>
      </form>
    </iron-form>
    <div class="actions">
      <paper-button on-click="_cancel" data-action="delete-request" title="Cancels any changes">cancel</paper-button>
      <template is="dom-if" if="[[isSaved]]">
        <paper-button on-click="_save" data-action="save-as-new" title="Saves request as new object">Save as new</paper-button>
        <paper-button class="action-button" on-click="_override" data-action="override" title="Replaces request data">Update</paper-button>
      </template>
      <template is="dom-if" if="[[!isSaved]]">
        <paper-button class="action-button" on-click="_save" data-action="save-request" title="Commits changes and stores request in data store">Save</paper-button>
      </template>
    </div>
  </template>
  <script>
  /**
   * A dialog to edit request meta data.
   *
   * ### Styling
   *
   * `<saved-request-editor>` provides the following custom properties and mixins
   * for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--saved-request-editor` | Mixin applied to the element | `{}`
   *
   * @polymer
   * @customElement
   * @memberof UiElements
   * @appliesMixin Polymer.IronResizableBehavior
   */
  class SavedRequestEditor extends
    Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element) {
    static get is() {return 'saved-request-editor';}
    static get properties() {
      return {
        /**
         * The request object to be saved / updated in the datastore.
         * It's not required for the editor to work.
         * This object will be attached to `save-request` object as a reference.
         * When this object change it computes values for `name`, `isSaved`,
         * `isDrive`, `projectName` and `projectId` properties.
         */
        request: Object,
        /**
         * Name of the request.
         */
        name: String,
        /**
         * Request description.
         */
        description: String,
        /**
         * Should be set if the request has been already saved in the datastore.
         * Adds UI controls to override or save as new.
         */
        isSaved: {
          type: Boolean,
          value: false,
          computed: '_computeIsSaved(request)'
        },
        /**
         * True when saving request to Google Drive.
         */
        isDrive: Boolean,
        /**
         * List of available projects.
         */
        projects: Array,
        /**
         * Set if the user chooses to override current request.
         */
        override: {
          type: Boolean,
          readOnly: true
        },
        // True when additional options are opened.
        additionalOptionsOpened: Boolean,
        /**
         * List of selected in the dialog project names.
         * @type {Array<String>}
         */
        selectedProjects: Array
      };
    }

    static get observers() {
      return [
        '_requestChanged(request, projects)'
      ];
    }

    constructor() {
      super();
      this._projectDataChanged = this._projectDataChanged.bind(this);
      this._datastoreDestroyed = this._datastoreDestroyed.bind(this);
    }

    connectedCallback() {
      super.connectedCallback();
      this._ensureAttribute('tabindex', -1);
      this._ensureAttribute('role', 'dialog');
      window.addEventListener('project-object-changed', this._projectDataChanged);
      window.addEventListener('project-object-deleted', this._projectDataChanged);
      window.addEventListener('datastore-destroyed', this._datastoreDestroyed);
      window.addEventListener('data-imported', this._projectDataChanged);
      this._refreshProjectsList();
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      window.removeEventListener('project-object-changed', this._projectDataChanged);
      window.removeEventListener('project-object-deleted', this._projectDataChanged);
      window.removeEventListener('datastore-destroyed', this._datastoreDestroyed);
      window.removeEventListener('data-imported', this._projectDataChanged);
    }

    /**
     * Updates the list of projects when project object changed.
     *
     * @param {CustomEvent} e
     */
    _projectDataChanged(e) {
      if (e.cancelable) {
        return;
      }
      this._refreshProjectsList();
    }
    /**
     * Updates the list of projects when project datastore has been destroyed.
     * @param {CustomEvent} e
     */
    _datastoreDestroyed(e) {
      const store = e.detail.datastore;
      if (typeof store === 'string') {
        if (store !== 'legacy-projects') {
          return;
        }
      } else {
        if (store.indexOf('legacy-projects') === -1) {
          return;
        }
      }
      this.set('projects', undefined);
      this._refreshProjectsList();
    }
    /**
     * Refreshes the list of projects after next render frame.
     */
    _refreshProjectsList() {
      Polymer.RenderStatus.afterNextRender(this, () => this._updateProjectsList());
    }

    /**
     * Resets the state of the UI
     */
    reset() {
      this.isDrive = false;
      this.name = '';
      this.description = '';
      this.set('selectedProjects', []);
    }
    /**
     * Sends the `cancel-request-edit` custom event to cancel the edit.
     */
    _cancel() {
      this.dispatchEvent(new CustomEvent('cancel-request-edit', {
        bubbles: false,
        composed: true
      }));
    }
    /**
     * Sets `override` to `false` and sends the form.
     */
    _save() {
      this._setOverride(false);
      this._sendForm();
    }
    /**
     * Sets `override` to `true` and sends the form.
     */
    _override() {
      this._setOverride(true);
      this._sendForm();
    }
    // Validates and submits the form.
    _sendForm() {
      if (!this.$.form.validate()) {
        return;
      }
      this.$.form.submit();
    }
    // Updates list of available projects after the overlay is opened.
    _updateProjectsList() {
      const e = new CustomEvent('project-model-query', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {}
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        console.warn('The project-model is not in the DOM.');
        return;
      }
      return e.detail.result
      .then((result) => result.sort(this._projectsSortFn))
      .then((result) => {
        this.set('projects', result);
        Polymer.RenderStatus.afterNextRender(this, () => this.notifyResize());
      })
      .catch((cause) => {
        this.dispatchEvent(new CustomEvent('send-analytics', {
          bubbles: true,
          composed: true,
          detail: {
            type: 'exception',
            description: 'save-dialog-view:' + cause.message,
            fatal: false
          }
        }));
        throw cause;
      });
    }
    // Sort function used to sort projects in order.
    _projectsSortFn(a, b) {
      if (a.order === b.order) {
        return 0;
      }
      if (a.order > b.order) {
        return 1;
      }
      if (a.order < b.order) {
        return -1;
      }
    }
    /**
     * Computes a list of suggestion for autocomplete element.
     * From the list of `projects` it takes names for each project and returns
     * new list for suggestions.
     * @param {Array<Object>} projects
     * @return {Array<String>}
     */
    _computeAutocomplete(projects) {
      if (!projects || !projects.length) {
        return;
      }
      return projects.map((item) => item.name);
    }
    /**
     * Sends the `save-request` custom event with computed detail object.
     *
     * @param {CustomEvent} e
     */
    _formSubmit(e) {
      e.preventDefault();
      const detail = this._computeEventDetail();

      this.dispatchEvent(new CustomEvent('save-request', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail
      }));
    }
    /**
     * Computes `save-request` custom event's `detail` object
     * @return {Object} A detail property of the event.
     */
    _computeEventDetail() {
      const storeRequest = Object.assign({}, this.request);
      storeRequest.name = this.name;
      if (this.description) {
        storeRequest.description = this.description;
      }
      if (!this.override && storeRequest._id) {
        delete storeRequest._id;
        delete storeRequest._rev;
      }
      const storeProjects = [];
      const selectedProjects = this.selectedProjects;
      const projects = this.projects || [];
      const projectsLength = projects.length;
      storeRequest.projects = [];
      if (selectedProjects && selectedProjects.length) {
        for (let i = 0, len = selectedProjects.length; i < len; i++) {
          const selected = selectedProjects[i];
          if (!selected) {
            continue;
          }
          const lowerSelected = selected.toLowerCase();
          let hasProject = false;
          for (let j = 0; j < projectsLength; j++) {
            if (projects[j].name.toLowerCase() === lowerSelected) {
              storeRequest.projects.push(projects[j]._id);
              hasProject = true;
              break;
            }
          }
          if (!hasProject) {
            storeProjects.push(selected);
          }
        }
      }
      const storeOptions = {
        isDrive: this.isDrive
      };
      if (!this.isDrive && storeRequest.driveId) {
        delete storeRequest.driveId;
      }
      return {
        request: storeRequest,
        projects: storeProjects.length ? storeProjects : undefined,
        options: storeOptions
      };
    }

    _toggleOptions() {
      this.additionalOptionsOpened = !this.additionalOptionsOpened;
    }

    _computeIsSaved(request) {
      if (!request) {
        return false;
      }
      const history = !!(request && request.type === 'history');
      return history ? false : !!request._id;
    }

    _requestChanged(request, projects) {
      if (!request) {
        this.reset();
        return;
      }
      const history = this.isHistory || request.type === 'history';
      const isDrive = history ? false : !!request.driveId;

      this.set('name', request.name || '');
      this.set('description', request.description || '');
      this.set('isDrive', isDrive);
      let projectIds = [];
      if (request.legacyProject) {
        projectIds[projectIds.length] = request.legacyProject;
      }
      if (request.projects) {
        projectIds = projectIds.concat(request.projects);
      }
      const projectsLen = (projects && projects.length);
      if (projectsLen) {
        let projectsData = [];
        projectIds.forEach((id) => {
          for (let i = 0; i < projectsLen; i++) {
            if (projects[i]._id === id) {
              projectsData[projectsData.length] = projects[i].name;
              return;
            }
          }
          projectsData[projectsData.length] = id;
        });
        this.set('selectedProjects', projectsData.length ? projectsData : undefined);
      } else {
        this.set('selectedProjects', projectIds.length ? projectIds : undefined);
      }
    }
    /**
     * Notifies resize when the height of autogrow textarea changes.
     */
    _autogrowCheckResize() {
      if (!this._lastAutogrowHeight) {
        this._lastAutogrowHeight = this.$.autogrow.offsetHeight;
        return;
      }
      if (this._lastAutogrowHeight !== this.$.autogrow.offsetHeight) {
        this._lastAutogrowHeight = this.$.autogrow.offsetHeight;
        this.notifyResize();
      }
    }

    /**
     * Fired when the user cancels the editor.
     * @event cancel-request-edit
     */

    /**
     * Fire when the user saves the request.
     *
     * @event save-request
     * @param {Object} request ArcRequest object with request data.
     * It is the copy of object assigned to `request` property.
     * If the user choose to save request as new object it's `_id` and `_rev`
     * properties are removed.
     * @param {?Array<String>} projects Optional list of new projects to create
     * with this request. It contains user entered names.
     * @param {Object} options Store options:
     * - isDrive {Boolean} If true then the request should be saved to Google
     * Drive as well.
     */
  }
  window.customElements.define(SavedRequestEditor.is, SavedRequestEditor);
  </script>
</dom-module>
