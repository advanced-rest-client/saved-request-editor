<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>
    <link rel="import" href="../saved-request-editor.html">
    <link rel="import" href="../../arc-demo-helpers/data-generator.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <saved-request-editor></saved-request-editor>
      </template>
    </test-fixture>

    <script>
    /* global fixture, assert, DataGenerator, MockInteractions, sinon, TestHelpers */

    const TEST_NAME = 'test-name';
    const TEST_DESCRIPTION = 'test-description';
    const TEST_PROJECT_NAME = 'test-project';
    var TEST_PROJECT_ID;
    var requests;
    var projects;

    function getActionItem(element, action) {
      var api = Polymer.dom(element.root);
      return api.querySelector('[data-action="' + action + '"]');
    }

    function prepareEventData(element, result) {
      element.addEventListener('save-request', function spy(e) {
        element.removeEventListener('save-request', spy);
        Object.keys(e.detail).forEach(name => {
          result[name] = e.detail[name];
        });
      });
      element.name = TEST_NAME;
    }

    suite('Saving new request', function() {
      suiteSetup(function() {
        return DataGenerator.insertSavedIfNotExists()
        .then(data => {
          requests = data.requests;
          projects = data.projects;
          TEST_PROJECT_ID = projects[0]._id;
        });
      });

      suiteTeardown(function() {
        return DataGenerator.destroySavedRequestData();
      });

      var element;
      setup(function(done) {
        element = fixture('basic');
        element.addEventListener('iron-resize', function resizeHandler() {
          element.removeEventListener('iron-resize', resizeHandler);
          done();
        });
      });

      test('save request button is not hidden', function() {
        var node = getActionItem(element, 'save-request');
        assert.isFalse(node.hidden);
      });

      test('Do not fire save-request event when form not validating', function() {
        var spy = sinon.spy();
        element.addEventListener('save-request', spy);
        var node = getActionItem(element, 'save-request');
        MockInteractions.tap(node);
        assert.isFalse(spy.called);
      });

      test('Fires save-request event when form is validating', function() {
        var spy = sinon.spy();
        element.name = TEST_NAME;
        element.addEventListener('save-request', spy);
        var node = getActionItem(element, 'save-request');
        MockInteractions.tap(node);
        assert.isTrue(spy.calledOnce);
      });

      function saveRequest() {
        var node = getActionItem(element, 'save-request');
        MockInteractions.tap(node);
      }

      test('save-request event is cancelable', function(done) {
        element.addEventListener('save-request', function spy(e) {
          element.removeEventListener('save-request', spy);
          assert.isTrue(e.cancelable);
          done();
        });
        element.name = TEST_NAME;
        saveRequest();
      });

      test('save-request event contains required data', function() {
        var eventData = {};
        prepareEventData(element, eventData);
        element.description = TEST_DESCRIPTION;
        saveRequest();
        assert.equal(eventData.name, TEST_NAME);
        assert.equal(eventData.description, TEST_DESCRIPTION);
        assert.typeOf(eventData.override, 'boolean');
        assert.typeOf(eventData.isDrive, 'boolean');
        assert.typeOf(eventData.isProject, 'boolean');
      });

      test('Event data for no project and no drive are set', function() {
        var eventData = {};
        prepareEventData(element, eventData);
        saveRequest();
        assert.isFalse(eventData.override, 'override is false');
        assert.isFalse(eventData.isDrive, 'isDrive is false');
        assert.isFalse(eventData.isProject, 'isProject is false');
      });

      test('Event data for no project and for drive are set', function() {
        var eventData = {};
        prepareEventData(element, eventData);
        element.isDrive = true;
        saveRequest();
        assert.isFalse(eventData.override, 'override is false');
        assert.isTrue(eventData.isDrive, 'isDrive is true');
        assert.isFalse(eventData.isProject, 'isProject is false');
      });

      test('Event data for existing project are set', function() {
        var eventData = {};
        prepareEventData(element, eventData);
        element.projectId = TEST_PROJECT_ID;
        assert.typeOf(element.projectName, 'string', 'Project name is computed');
        assert.isFalse(element.projectIsNew, 'projectIsNew is computed');
        saveRequest();
        assert.isFalse(eventData.override, 'override is false');
        assert.isFalse(eventData.isDrive, 'isDrive is false');
        assert.isTrue(eventData.isProject, 'isProject is true');
        assert.equal(eventData.projectId, TEST_PROJECT_ID, 'Project ID is set');
        assert.isFalse(eventData.projectIsNew, 'projectIsNew is set');
      });

      test('Event data for new project are set', function() {
        var eventData = {};
        prepareEventData(element, eventData);
        element.projectName = TEST_PROJECT_NAME;
        assert.isUndefined(element.projectId, 'Project id is not computed');
        assert.isTrue(element.projectIsNew, 'projectIsNew is computed');
        saveRequest();
        assert.isFalse(eventData.override, 'override is false');
        assert.isFalse(eventData.isDrive, 'isDrive is false');
        assert.isTrue(eventData.isProject, 'isProject is true');
        assert.equal(eventData.projectName, TEST_PROJECT_NAME, 'Project name is set');
        assert.isTrue(eventData.projectIsNew, 'projectIsNew is set');
      });
    });

    suite('Saving existing request - basics', function() {
      suiteSetup(function() {
        return DataGenerator.insertSavedIfNotExists()
        .then(data => {
          requests = data.requests;
          projects = data.projects;
          TEST_PROJECT_ID = projects[0]._id;
        });
      });

      suiteTeardown(function() {
        return DataGenerator.destroySavedRequestData();
      });

      var element;
      setup(function(done) {
        element = fixture('basic');
        element.addEventListener('iron-resize', function resizeHandler() {
          element.removeEventListener('iron-resize', resizeHandler);
          element.request = requests[0];
          TestHelpers.forceXIfStamp(element);
          done();
        });
      });

      test('isSaved property is computed', function() {
        assert.isTrue(element.isSaved);
      });

      test('save request button is hidden', function() {
        var node = getActionItem(element, 'save-request');
        assert.isTrue(node.hidden);
      });

      test('save as new button is rendered', function() {
        var node = getActionItem(element, 'save-as-new');
        assert.ok(node);
      });

      test('override button is rendered', function() {
        var node = getActionItem(element, 'override');
        assert.ok(node);
      });
    });

    suite('Saving existing request with project', function() {
      suiteSetup(function() {
        return DataGenerator.insertSavedIfNotExists()
        .then(data => {
          requests = data.requests;
          projects = data.projects;
          TEST_PROJECT_ID = projects[0]._id;
        });
      });

      suiteTeardown(function() {
        return DataGenerator.destroySavedRequestData();
      });

      var element;
      setup(function(done) {
        element = fixture('basic');
        element.addEventListener('iron-resize', function resizeHandler() {
          element.removeEventListener('iron-resize', resizeHandler);
          element.request = requests.find(item => item.legacyProject);
          TestHelpers.forceXIfStamp(element);
          done();
        });
      });

      function saveRequest() {
        var node = getActionItem(element, 'save-as-new');
        MockInteractions.tap(node);
      }

      function overrideRequest() {
        var node = getActionItem(element, 'override');
        MockInteractions.tap(node);
      }

      test('projectName property is computed', function() {
        assert.typeOf(element.projectName, 'string');
      });

      test('projectId property is computed', function() {
        assert.typeOf(element.projectId, 'string');
      });

      test('projectIsNew property is computed', function() {
        assert.isFalse(element.projectIsNew);
      });

      test('Clears project data when request change', function() {
        var requestCopy = Object.assign({}, element.request);
        delete requestCopy.legacyProject;
        element.request = requestCopy;
        assert.isUndefined(element.projectId, 'projectId is cleared');
        assert.equal(element.projectName, '', 'projectName is cleared');
      });

      test('Event data for override are set', function() {
        var eventData = {};
        prepareEventData(element, eventData);
        overrideRequest();
        assert.isTrue(eventData.override, 'override is true');
        assert.typeOf(eventData.isDrive, 'boolean', 'isDrive is set');
        assert.isTrue(eventData.isProject, 'isProject is true');
        assert.equal(eventData.projectId, element.request.legacyProject, 'ProjectId is set');
        assert.isFalse(eventData.projectIsNew, 'projectIsNew is set');
        assert.deepEqual(eventData.request, element.request, 'Request object is set');
      });

      test('Event data for save as new are set', function() {
        var eventData = {};
        prepareEventData(element, eventData);
        saveRequest();
        assert.isFalse(eventData.override, 'override is false');
        assert.typeOf(eventData.isDrive, 'boolean', 'isDrive is set');
        assert.isTrue(eventData.isProject, 'isProject is true');
        assert.equal(eventData.projectId, element.request.legacyProject, 'ProjectId is set');
        assert.isFalse(eventData.projectIsNew, 'projectIsNew is set');
        assert.deepEqual(eventData.request, element.request, 'Request object is set');
      });

      test('Change project name of the request to other existing', function() {
        var eventData = {};
        prepareEventData(element, eventData);

        var currentProjectId = element.request.legacyProject;
        var newProject = projects.find(item => item._id !== currentProjectId);
        element.projectName = newProject.name;
        TestHelpers.forceXIfStamp(element);

        saveRequest();
        assert.isFalse(eventData.override, 'override is false');
        assert.typeOf(eventData.isDrive, 'boolean', 'isDrive is set');
        assert.isTrue(eventData.isProject, 'isProject is true');
        assert.equal(eventData.projectId, newProject._id, 'ProjectId is set');
        assert.isFalse(eventData.projectIsNew, 'projectIsNew is set');
        assert.deepEqual(eventData.request, element.request, 'Request object is set');
      });

      test('Change project name of the request to not existing', function() {
        var eventData = {};
        prepareEventData(element, eventData);
        element.projectName = TEST_PROJECT_NAME;
        TestHelpers.forceXIfStamp(element);

        saveRequest();
        assert.isFalse(eventData.override, 'override is false');
        assert.typeOf(eventData.isDrive, 'boolean', 'isDrive is set');
        assert.isTrue(eventData.isProject, 'isProject is true');
        assert.equal(eventData.projectName, TEST_PROJECT_NAME, 'Project name is set');
        assert.isTrue(eventData.projectIsNew, 'projectIsNew is set');
        assert.deepEqual(eventData.request, element.request, 'Request object is set');
      });
    });
    </script>

  </body>
</html>
