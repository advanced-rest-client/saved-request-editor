<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <link rel="import" href="../saved-request-editor.html">
    <link rel="import" href="../../app-pouchdb/pouchdb.html">
    <link rel="import" href="../../arc-models/project-model.html">
    <link rel="import" href="../../arc-data-generator/arc-data-generator.html">
  </head>
  <body>
    <project-model></project-model>
    <test-fixture id="basic">
      <template>
        <saved-request-editor></saved-request-editor>
      </template>
    </test-fixture>

    <script>
    /* global fixture, assert, DataGenerator, sinon, TestHelpers */

    const TEST_NAME = 'test-name';
    const TEST_DESCRIPTION = 'test-description';
    const TEST_PROJECT_NAME = 'test-project';
    let TEST_PROJECT_ID;
    let requests;
    let projects;

    function getActionItem(element, action) {
      return element.shadowRoot.querySelector('[data-action="' + action + '"]');
    }

    function prepareEventData(element, result) {
      element.addEventListener('save-request', function spy(e) {
        element.removeEventListener('save-request', spy);
        Object.keys(e.detail).forEach((name) => {
          result[name] = e.detail[name];
        });
      });
      element.name = TEST_NAME;
    }

    suite('Saving new request', function() {
      suiteSetup(function() {
        return DataGenerator.insertSavedIfNotExists()
        .then((data) => {
          requests = data.requests;
          projects = data.projects;
          TEST_PROJECT_ID = projects[0]._id;
        });
      });

      suiteTeardown(function() {
        return DataGenerator.destroySavedRequestData();
      });

      let element;
      setup(function(done) {
        element = fixture('basic');
        element.addEventListener('iron-resize', function resizeHandler() {
          element.removeEventListener('iron-resize', resizeHandler);
          done();
        });
      });

      test('save request button is not hidden', function() {
        const node = getActionItem(element, 'save-request');
        assert.isFalse(node.hidden);
      });

      test('Do not fire save-request event when form not validating', function() {
        const spy = sinon.spy();
        element.addEventListener('save-request', spy);
        const node = getActionItem(element, 'save-request');
        node.click();
        assert.isFalse(spy.called);
      });

      test('Fires save-request event when form is validating', function() {
        const spy = sinon.spy();
        element.name = TEST_NAME;
        element.addEventListener('save-request', spy);
        const node = getActionItem(element, 'save-request');
        node.click();
        assert.isTrue(spy.calledOnce);
      });

      function saveRequest() {
        const node = getActionItem(element, 'save-request');
        node.click();
      }

      test('save-request event is cancelable', function(done) {
        element.addEventListener('save-request', function spy(e) {
          element.removeEventListener('save-request', spy);
          assert.isTrue(e.cancelable);
          done();
        });
        element.name = TEST_NAME;
        saveRequest();
      });

      test('save-request event contains required data', function() {
        const eventData = {};
        prepareEventData(element, eventData);
        element.description = TEST_DESCRIPTION;
        saveRequest();
        assert.equal(eventData.name, TEST_NAME);
        assert.equal(eventData.description, TEST_DESCRIPTION);
        assert.typeOf(eventData.override, 'boolean');
        assert.typeOf(eventData.isDrive, 'boolean');
        assert.typeOf(eventData.isProject, 'boolean');
      });

      test('Event data for no project and no drive are set', function() {
        const eventData = {};
        prepareEventData(element, eventData);
        saveRequest();
        assert.isFalse(eventData.override, 'override is false');
        assert.isFalse(eventData.isDrive, 'isDrive is false');
        assert.isFalse(eventData.isProject, 'isProject is false');
      });

      test('Event data for no project and for drive are set', function() {
        const eventData = {};
        prepareEventData(element, eventData);
        element.isDrive = true;
        saveRequest();
        assert.isFalse(eventData.override, 'override is false');
        assert.isTrue(eventData.isDrive, 'isDrive is true');
        assert.isFalse(eventData.isProject, 'isProject is false');
      });

      test('Event data for existing project are set', function() {
        const eventData = {};
        prepareEventData(element, eventData);
        element.projectId = TEST_PROJECT_ID;
        assert.typeOf(element.projectName, 'string', 'Project name is computed');
        assert.isFalse(element.projectIsNew, 'projectIsNew is computed');
        saveRequest();
        assert.isFalse(eventData.override, 'override is false');
        assert.isFalse(eventData.isDrive, 'isDrive is false');
        assert.isTrue(eventData.isProject, 'isProject is true');
        assert.equal(eventData.projectId, TEST_PROJECT_ID, 'Project ID is set');
        assert.isFalse(eventData.projectIsNew, 'projectIsNew is set');
      });

      test('Event data for new project are set', function() {
        const eventData = {};
        prepareEventData(element, eventData);
        element.projectName = TEST_PROJECT_NAME;
        assert.isUndefined(element.projectId, 'Project id is not computed');
        assert.isTrue(element.projectIsNew, 'projectIsNew is computed');
        saveRequest();
        assert.isFalse(eventData.override, 'override is false');
        assert.isFalse(eventData.isDrive, 'isDrive is false');
        assert.isTrue(eventData.isProject, 'isProject is true');
        assert.equal(eventData.projectName, TEST_PROJECT_NAME, 'Project name is set');
        assert.isTrue(eventData.projectIsNew, 'projectIsNew is set');
      });
    });

    suite('Saving existing request - basics', function() {
      suiteSetup(function() {
        return DataGenerator.insertSavedIfNotExists()
        .then((data) => {
          requests = data.requests;
          projects = data.projects;
          TEST_PROJECT_ID = projects[0]._id;
        });
      });

      suiteTeardown(function() {
        return DataGenerator.destroySavedRequestData();
      });

      let element;
      setup(function(done) {
        element = fixture('basic');
        element.addEventListener('iron-resize', function resizeHandler() {
          element.removeEventListener('iron-resize', resizeHandler);
          element.request = requests[0];
          flush(() => done());
        });
      });

      test('isSaved property is computed', function() {
        assert.isTrue(element.isSaved);
      });

      test('save request button is hidden', function() {
        const node = getActionItem(element, 'save-request');
        assert.isTrue(node.hidden);
      });

      test('save as new button is rendered', function() {
        const node = getActionItem(element, 'save-as-new');
        assert.ok(node);
      });

      test('override button is rendered', function() {
        const node = getActionItem(element, 'override');
        assert.ok(node);
      });
    });

    suite('Saving existing request with project', function() {
      suiteSetup(function() {
        return DataGenerator.insertSavedIfNotExists()
        .then((data) => {
          requests = data.requests;
          projects = data.projects;
          TEST_PROJECT_ID = projects[0]._id;
        });
      });

      suiteTeardown(function() {
        return DataGenerator.destroySavedRequestData();
      });

      let element;
      setup(function(done) {
        element = fixture('basic');
        element.addEventListener('iron-resize', function resizeHandler() {
          element.removeEventListener('iron-resize', resizeHandler);
          element.request = requests.find((item) => item.legacyProject);
          flush(() => done());
        });
      });

      function saveRequest() {
        const node = getActionItem(element, 'save-as-new');
        node.click();
      }

      function overrideRequest() {
        const node = getActionItem(element, 'override');
        node.click();
      }

      test('projectName property is computed', function() {
        assert.typeOf(element.projectName, 'string');
      });

      test('projectId property is computed', function() {
        assert.typeOf(element.projectId, 'string');
      });

      test('projectIsNew property is computed', function() {
        assert.isFalse(element.projectIsNew);
      });

      test('Clears project data when request change', function() {
        const requestCopy = Object.assign({}, element.request);
        delete requestCopy.legacyProject;
        element.request = requestCopy;
        assert.isUndefined(element.projectId, 'projectId is cleared');
        assert.equal(element.projectName, '', 'projectName is cleared');
      });

      test('Event data for override are set', function() {
        const eventData = {};
        prepareEventData(element, eventData);
        overrideRequest();
        assert.isTrue(eventData.override, 'override is true');
        assert.typeOf(eventData.isDrive, 'boolean', 'isDrive is set');
        assert.isTrue(eventData.isProject, 'isProject is true');
        assert.equal(eventData.projectId, element.request.legacyProject, 'ProjectId is set');
        assert.isFalse(eventData.projectIsNew, 'projectIsNew is set');
        assert.deepEqual(eventData.request, element.request, 'Request object is set');
      });

      test('Event data for save as new are set', function() {
        const eventData = {};
        prepareEventData(element, eventData);
        saveRequest();
        assert.isFalse(eventData.override, 'override is false');
        assert.typeOf(eventData.isDrive, 'boolean', 'isDrive is set');
        assert.isTrue(eventData.isProject, 'isProject is true');
        assert.equal(eventData.projectId, element.request.legacyProject, 'ProjectId is set');
        assert.isFalse(eventData.projectIsNew, 'projectIsNew is set');
        assert.deepEqual(eventData.request, element.request, 'Request object is set');
      });

      test('Change project name of the request to other existing', function(done) {
        const eventData = {};
        prepareEventData(element, eventData);

        const currentProjectId = element.request.legacyProject;
        const newProject = projects.find((item) => item._id !== currentProjectId);
        element.projectName = newProject.name;
        flush(() => {
          saveRequest();
          assert.isFalse(eventData.override, 'override is false');
          assert.typeOf(eventData.isDrive, 'boolean', 'isDrive is set');
          assert.isTrue(eventData.isProject, 'isProject is true');
          assert.equal(eventData.projectId, newProject._id, 'ProjectId is set');
          assert.isFalse(eventData.projectIsNew, 'projectIsNew is set');
          assert.deepEqual(eventData.request, element.request, 'Request object is set');
          done();
        });
      });

      test('Change project name of the request to not existing', function(done) {
        const eventData = {};
        prepareEventData(element, eventData);
        element.projectName = TEST_PROJECT_NAME;
        flush(() => {
          saveRequest();
          assert.isFalse(eventData.override, 'override is false');
          assert.typeOf(eventData.isDrive, 'boolean', 'isDrive is set');
          assert.isTrue(eventData.isProject, 'isProject is true');
          assert.equal(eventData.projectName, TEST_PROJECT_NAME, 'Project name is set');
          assert.isTrue(eventData.projectIsNew, 'projectIsNew is set');
          assert.deepEqual(eventData.request, element.request, 'Request object is set');
          done();
        });
      });
    });
    </script>

  </body>
</html>
