<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <link rel="import" href="../saved-request-editor.html">
  </head>
  <body>
    <test-fixture id="Basic">
      <template>
        <saved-request-editor></saved-request-editor>
      </template>
    </test-fixture>

    <test-fixture id="NewRequest">
      <template>
        <saved-request-editor request='{"method":"GET","url":"https://domain.com","headers":"a-abc:test"}' name="test-name" description="test-description"></saved-request-editor>
      </template>
    </test-fixture>

    <test-fixture id="ExistingRequest">
      <template>
        <saved-request-editor request='{"method":"GET","url":"https://domain.com","headers":"a-abc:test","_id":"test-id","_rev":"test-rev","type":"saved"}' name="test-name" description="test-description"></saved-request-editor>
      </template>
    </test-fixture>

    <script>
    suite('saved-request-editor', function() {
      function projectsRequestHandler(e) {
        e.preventDefault();
        e.detail.result = Promise.resolve([{
          name: 'p1',
          order: 2,
          _id: 'id-1'
        }, {
          name: 'p2',
          order: 1,
          _id: 'id-2'
        }]);
      }
      suiteSetup(function() {
        window.addEventListener('project-model-query', projectsRequestHandler);
      });

      suiteTeardown(function() {
        window.removeEventListener('project-model-query', projectsRequestHandler);
      });

      function getActionItem(node, action) {
        return node.shadowRoot.querySelector('[data-action="' + action + '"]');
      }

      suite('Basics', function() {
        test('Queries for projects', function(done) {
          const element = fixture('Basic');
          element.addEventListener('project-model-query', (e) => {
            assert.isTrue(e.cancelable);
            done();
          });
        });

        test('save request button is rendered', function(done) {
          const element = fixture('Basic');
          flush(() => {
            const node = getActionItem(element, 'save-request');
            assert.ok(node);
            done();
          });
        });
      });

      suite('Validation', function() {
        test('save-request event is not fired when invalid', function(done) {
          const element = fixture('Basic');
          flush(() => {
            const spy = sinon.spy();
            element.addEventListener('save-request', spy);
            const node = getActionItem(element, 'save-request');
            node.click();
            assert.isFalse(spy.called);
            done();
          });
        });

        test('Fires save-request event when form is valid', function(done) {
          const element = fixture('Basic');
          flush(() => {
            const spy = sinon.spy();
            element.name = 'test';
            element.addEventListener('save-request', spy);
            const node = getActionItem(element, 'save-request');
            node.click();
            assert.isTrue(spy.calledOnce);
            done();
          });
        });
      });

      suite('Setting request data', function() {
        let element;
        setup((done) => {
          element = fixture('Basic');
          element.addEventListener('iron-resize', function f() {
            element.removeEventListener('iron-resize', f);
            done();
          });
        });

        test('Sets name from request name', () => {
          element.request = {
            name: 'test'
          };
          assert.equal(element.name, 'test');
        });

        test('Sets description from request description', () => {
          element.request = {
            description: 'test'
          };
          assert.equal(element.description, 'test');
        });

        test('Sets isDrive when driveId is set on request', () => {
          element.request = {
            driveId: 'test'
          };
          assert.isTrue(element.isDrive);
        });

        test('Does not set isDrive when request type is history', () => {
          element.request = {
            driveId: 'test',
            type: 'history'
          };
          assert.isFalse(element.isDrive);
        });

        test('Does not set selectedProjects when no project info', () => {
          element.request = {};
          assert.isUndefined(element.selectedProjects);
        });

        test('Sets project id from legacyProject', () => {
          element.request = {
            legacyProject: 'unknown'
          };
          assert.equal(element.selectedProjects[0], 'unknown');
        });

        test('Sets project name from legacyProject', () => {
          element.request = {
            legacyProject: 'id-1'
          };
          assert.equal(element.selectedProjects[0], 'p1');
        });

        test('Sets project id from projects array', () => {
          element.request = {
            projects: ['unknown']
          };
          assert.equal(element.selectedProjects[0], 'unknown');
        });

        test('Sets project name from projects array', () => {
          element.request = {
            projects: ['id-1']
          };
          assert.equal(element.selectedProjects[0], 'p1');
        });

        test('isSaved is false when no rev', function() {
          element.request = {};
          assert.isFalse(element.isSaved);
        });

        test('isSaved is true when id', function() {
          element.request = {
            _rev: 'test'
          };
          assert.isTrue(element.isSaved);
        });

        test('isSaved is always false for history item', function() {
          element.request = {
            _rev: 'test',
            type: 'history'
          };
          assert.isFalse(element.isSaved);
        });

        test('Renders override button for saved request', (done) => {
          element.request = {
            _rev: 'test'
          };
          flush(() => {
            const node = getActionItem(element, 'override');
            assert.ok(node);
            done();
          });
        });

        test('Renders save as new button for saved request', (done) => {
          element.request = {
            _rev: 'test'
          };
          flush(() => {
            const node = getActionItem(element, 'save-as-new');
            assert.ok(node);
            done();
          });
        });
      });

      suite('_computeEventDetail()', function() {
        let element;

        test('Contains request data', function(done) {
          element = fixture('NewRequest');
          flush(() => {
            const result = element._computeEventDetail();
            assert.deepEqual(result.request, {
              method: 'GET',
              url: 'https://domain.com',
              headers: 'a-abc:test',
              name: '',
              projects: []
            });
            done();
          });
        });

        test('Contains request name', function(done) {
          element = fixture('NewRequest');
          flush(() => {
            element.name = 'test-name';
            const result = element._computeEventDetail();
            assert.deepEqual(result.request, {
              method: 'GET',
              url: 'https://domain.com',
              headers: 'a-abc:test',
              name: 'test-name',
              projects: []
            });
            done();
          });
        });

        test('Contains request description', function(done) {
          element = fixture('NewRequest');
          flush(() => {
            element.description = 'test-desc';
            const result = element._computeEventDetail();
            assert.deepEqual(result.request, {
              method: 'GET',
              url: 'https://domain.com',
              headers: 'a-abc:test',
              name: '',
              description: 'test-desc',
              projects: []
            });
            done();
          });
        });

        test('Adds existing projects', function(done) {
          element = fixture('NewRequest');
          element.addEventListener('iron-resize', function f() {
            element.removeEventListener('iron-resize', f);
            element.selectedProjects = ['p1'];
            const result = element._computeEventDetail();
            assert.deepEqual(result.request, {
              method: 'GET',
              url: 'https://domain.com',
              headers: 'a-abc:test',
              name: '',
              projects: ['id-1']
            });
            done();
          });
        });

        test('Adds not existing projects', function(done) {
          element = fixture('NewRequest');
          flush(() => {
            element.selectedProjects = ['something'];
            const result = element._computeEventDetail();
            assert.deepEqual(result.projects, ['something']);
            done();
          });
        });

        test('Adds both existing and non-existing projects', function(done) {
          element = fixture('NewRequest');

          element.addEventListener('iron-resize', function f() {
            element.removeEventListener('iron-resize', f);
            element.selectedProjects = ['p1', 'something'];
            const result = element._computeEventDetail();
            assert.deepEqual(result.request.projects, ['id-1']);
            assert.deepEqual(result.projects, ['something']);
            done();
          });
        });

        test('Keeps _id and _rev when updating request', function(done) {
          element = fixture('ExistingRequest');
          flush(() => {
            element._setOverride(true);
            const result = element._computeEventDetail();
            assert.equal(result.request._id, 'test-id');
            assert.equal(result.request._rev, 'test-rev');
            done();
          });
        });

        test('Removes _id and _rev when overriding request', function(done) {
          element = fixture('ExistingRequest');
          flush(() => {
            element._setOverride(false);
            const result = element._computeEventDetail();
            assert.isUndefined(result.request._id);
            assert.isUndefined(result.request._rev);
            done();
          });
        });

        test('Sets isDrive on options', function(done) {
          element = fixture('ExistingRequest');
          flush(() => {
            element._setOverride(false);
            element.isDrive = true;
            const result = element._computeEventDetail();
            assert.isTrue(result.options.isDrive);
            done();
          });
        });
      });

      suite('save-request event dispatch', function() {
        let element;
        setup((done) => {
          element = fixture('ExistingRequest');
          element.addEventListener('iron-resize', function f() {
            element.removeEventListener('iron-resize', f);
            element.name = 'test-name';
            element.selectedProjects = ['p1', 'something'];
            done();
          });
        });

        test('Save request event is cancelable', (done) => {
          element.addEventListener('save-request', function(e) {
            assert.isTrue(e.cancelable);
            done();
          });
          const node = getActionItem(element, 'override');
          node.click();
        });

        test('Dispatches update type event', (done) => {
          element.addEventListener('save-request', function(e) {
            const data = e.detail;
            assert.equal(data.request._id, 'test-id');
            assert.equal(data.request._rev, 'test-rev');
            done();
          });
          const node = getActionItem(element, 'override');
          node.click();
        });

        test('Update type event has all detail properties', (done) => {
          element.addEventListener('save-request', function(e) {
            const data = e.detail;
            assert.ok(data.request);
            assert.ok(data.projects);
            assert.ok(data.projects);
            done();
          });
          const node = getActionItem(element, 'override');
          node.click();
        });

        test('Dispatches save as new type event', (done) => {
          element.addEventListener('save-request', function(e) {
            const data = e.detail;
            assert.isUndefined(data.request._id);
            assert.isUndefined(data.request._rev);
            done();
          });
          const node = getActionItem(element, 'save-as-new');
          node.click();
        });

        test('Save as new type event has all detail properties', (done) => {
          element.addEventListener('save-request', function(e) {
            const data = e.detail;
            assert.ok(data.request);
            assert.ok(data.projects);
            assert.ok(data.projects);
            done();
          });
          const node = getActionItem(element, 'save-as-new');
          node.click();
        });
      });
    });
    </script>
  </body>
</html>
